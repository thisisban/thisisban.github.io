<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Math Game</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üßÆ</text></svg>">
    
    <!-- Material Symbols -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    
    <!-- –®—Ä–∏—Ñ—Ç—ã –∫–∞–∫ –≤ Flet -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap');
        
        /* Product Sans –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω –≤ Google Fonts, –∏—Å–ø–æ–ª—å–∑—É–µ–º Roboto –∫–∞–∫ –∑–∞–ø–∞—Å–Ω–æ–π */
        /* Google Sans Code –ø–æ—Ö–æ–∂ –Ω–∞ Source Code Pro */
        @import url('https://fonts.googleapis.com/css2?family=Source+Code+Pro:wght@400;500&display=swap');
        
        /* –°–æ–∑–¥–∞–µ–º –∫–∞—Å—Ç–æ–º–Ω—ã–µ —Å–≤–æ–π—Å—Ç–≤–∞ –¥–ª—è —à—Ä–∏—Ñ—Ç–æ–≤ –∫–∞–∫ –≤ Flet */
        :root {
            --font-product-sans: 'Roboto', -apple-system, BlinkMacSystemFont, sans-serif;
            --font-google-sans-code: 'Source Code Pro', 'Roboto Mono', monospace;
            --font-material-icons: 'Material Symbols Outlined';
        }
    </style>
    
    <!-- Confetti -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
    
    <style>
        /* Reset –∏ –±–∞–∑–æ–≤—ã–µ —Å—Ç–∏–ª–∏ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-product-sans);
            background: linear-gradient(135deg, #FFFDE7 0%, #FFF9C4 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏—è (–∫–∞–∫ –≤ Flet) */
        .game-wrapper {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        /* –û—Å–Ω–æ–≤–Ω–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞ (—Ç–æ—á–Ω–∞—è –∫–æ–ø–∏—è Flet) */
        .math-game-card {
            background: white;
            border-radius: 24px;
            box-shadow: 
                0 1px 3px rgba(0,0,0,0.12),
                0 1px 2px rgba(0,0,0,0.24),
                0 3px 6px rgba(0,0,0,0.16),
                0 6px 12px rgba(0,0,0,0.12),
                0 12px 24px rgba(0,0,0,0.08),
                0 24px 48px rgba(0,0,0,0.06);
            padding: 24px;
            width: 400px;
            position: relative;
            overflow: hidden;
            border: none;
        }

        /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –≤–Ω—É—Ç—Ä–∏ –∫–∞—Ä—Ç–æ—á–∫–∏ —Å Stack –∫–∞–∫ –≤ Flet */
        .card-content {
            position: relative;
            width: 100%;
            height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* –î–≤–∞ —Ä–µ–∂–∏–º–∞ - –∫–∞–∫ Stack –≤ Flet */
        .game-mode {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            transition: opacity 300ms ease-in-out;
        }

        /* –†–µ–∂–∏–º –≤–≤–æ–¥–∞ */
        .input-mode {
            opacity: 1;
            z-index: 2;
        }

        .input-mode.hidden {
            opacity: 0;
            pointer-events: none;
        }

        /* –†–µ–∂–∏–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ */
        .result-mode {
            opacity: 0;
            z-index: 1;
            justify-content: center;
            align-items: center;
            text-align: center;
        }

        .result-mode.active {
            opacity: 1;
            pointer-events: auto;
        }

        /* –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∫–∞–∫ ListTile –≤ Flet */
        .problem-header {
            margin-bottom: 24px;
        }

        .problem-title {
            font-size: 32px;
            font-weight: 700;
            color: #1a1a1a;
            margin-bottom: 4px;
            font-variant-numeric: tabular-nums;
            text-align: center;
        }

        .problem-subtitle {
            font-size: 14px;
            color: #666;
            text-align: center;
            opacity: 0.8;
        }

        /* –ü–æ–ª–µ –≤–≤–æ–¥–∞ –∫–∞–∫ –≤ Flet */
        .answer-input {
            width: 100%;
            padding: 16px;
            font-size: 18px;
            font-family: var(--font-product-sans);
            background: #f5f5f5;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            color: #1a1a1a;
            transition: all 0.2s ease;
            margin-bottom: 20px;
            text-align: center;
        }

        .answer-input:focus {
            outline: none;
            border-color: #FFD600;
            background: white;
        }

        /* –ö–Ω–æ–ø–∫–∞ –∫–∞–∫ –≤ Flet */
        .check-button {
            background: #FFD600;
            color: #1a1a1a;
            border: none;
            border-radius: 12px;
            padding: 16px 32px;
            font-size: 16px;
            font-weight: 600;
            font-family: var(--font-product-sans);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s ease;
            width: 100%;
            text-transform: none;
            letter-spacing: normal;
        }

        .check-button:hover:not(:disabled) {
            background: #FFC400;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(255, 214, 0, 0.3);
        }

        .check-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* –ò–∫–æ–Ω–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –∫–∞–∫ –≤ Flet */
        .result-icon-container {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 20px;
            width: 120px;
            height: 120px;
        }

        .result-icon {
            font-size: 120px;
            color: #4CAF50;
            transform-origin: center;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .result-icon.success {
            color: #4CAF50;
        }

        .result-icon.error {
            color: #F44336;
        }

        .result-icon.settings {
            color: #2196F3;
        }

        /* –¢–µ–∫—Å—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ */
        .result-text {
            font-size: 20px;
            font-weight: 500;
            margin-bottom: 12px;
            color: #1a1a1a;
        }

        .result-text.success {
            color: #4CAF50;
        }

        .result-text.error {
            color: #F44336;
        }

        .result-text.settings {
            color: #2196F3;
        }

        /* –°—á–µ—Ç—á–∏–∫ —Å–µ—Ä–∏–∏ */
        .strike-counter {
            font-size: 16px;
            color: #666;
            background: #f5f5f5;
            padding: 8px 16px;
            border-radius: 20px;
            display: inline-block;
            opacity: 0.8;
        }

        .strike-counter.hidden {
            display: none;
        }

        /* GIF –∫–æ–Ω—Ñ–µ—Ç—Ç–∏ */
        .confetti-gif {
            width: 120px;
            height: 120px;
            object-fit: contain;
            display: none;
        }

        .confetti-gif.active {
            display: block;
        }

        /* –§—É—Ç–µ—Ä —Å –≤–µ—Ä—Å–∏–µ–π */
        .game-footer {
            margin-top: 24px;
            text-align: center;
            font-family: var(--font-google-sans-code);
            font-size: 12px;
            color: #999;
            opacity: 0.5;
        }

        /* –ê–Ω–∏–º–∞—Ü–∏–∏ –∫–∞–∫ –≤ Flet */
        @keyframes rotateAndScale {
            0% {
                transform: rotate(-45deg) scale(4);
            }
            100% {
                transform: rotate(0deg) scale(1);
            }
        }

        @keyframes rotateSlow {
            0% {
                transform: rotate(-720deg);
            }
            100% {
                transform: rotate(0deg);
            }
        }

        .animate-fast {
            animation: rotateAndScale 1s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
        }

        .animate-slow {
            animation: rotateSlow 3s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
        }

        /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
        @media (max-width: 480px) {
            .math-game-card {
                width: 320px;
                padding: 16px;
            }
            
            .card-content {
                height: 250px;
            }
            
            .problem-title {
                font-size: 28px;
            }
            
            .result-icon-container {
                width: 100px;
                height: 100px;
            }
            
            .result-icon {
                font-size: 100px;
            }
        }

        /* –°–∫—Ä—ã—Ç—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã */
        .hidden {
            display: none !important;
        }

        /* Material Icons */
        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }

        /* –ö–æ–Ω—Ñ–µ—Ç—Ç–∏ canvas */
        #confettiCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 9999;
            display: none;
        }

        /* –ó–∞–≥—Ä—É–∑–∫–∞ */
        .loading {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            border-radius: 24px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #FFD600;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –∫–∞–∫ –≤ Flet -->
    <div class="game-wrapper">
        <!-- –û—Å–Ω–æ–≤–Ω–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞ -->
        <div class="math-game-card">
            <!-- Loading -->
            <div class="loading" id="loadingScreen">
                <div class="spinner"></div>
            </div>

            <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –∫–∞—Ä—Ç–æ—á–∫–∏ -->
            <div class="card-content">
                <!-- –†–µ–∂–∏–º –≤–≤–æ–¥–∞ -->
                <div class="game-mode input-mode" id="inputMode">
                    <div class="problem-header">
                        <div class="problem-title" id="problemText">5 + 3 =</div>
                        <div class="problem-subtitle">–ù–∞–π–¥–∏ –∑–Ω–∞—á–µ–Ω–∏–µ –≤—ã—Ä–∞–∂–µ–Ω–∏—è</div>
                    </div>
                    
                    <input 
                        type="number" 
                        class="answer-input" 
                        id="answerInput"
                        placeholder="–†–µ—à–µ–Ω–∏–µ"
                        inputmode="numeric"
                        pattern="[0-9\-]*"
                        autofocus
                    />
                    
                    <button class="check-button" id="checkButton">
                        <span class="material-symbols-outlined">check</span>
                        –ü—Ä–æ–≤–µ—Ä–∏—Ç—å
                    </button>
                </div>

                <!-- –†–µ–∂–∏–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ -->
                <div class="game-mode result-mode" id="resultMode">
                    <div class="result-icon-container">
                        <div class="result-icon success" id="resultIcon">
                            <span class="material-symbols-outlined">check_circle</span>
                        </div>
                        <!-- GIF –∫–æ–Ω—Ñ–µ—Ç—Ç–∏ –¥–ª—è –æ—Å–æ–±—ã—Ö —Å–ª—É—á–∞–µ–≤ -->
                        <img src="https://i.giphy.com/media/3o7abldj0b3rxrZUxW/giphy.gif" 
                             class="confetti-gif" 
                             id="confettiGif"
                             alt="–ö–æ–Ω—Ñ–µ—Ç—Ç–∏"
                             crossorigin="anonymous">
                    </div>
                    
                    <div class="result-text success" id="resultText">–í–µ—Ä–Ω–æ!</div>
                    
                    <div class="strike-counter hidden" id="strikeCounter">
                        <span id="strikeText">–ü–æ–¥—Ä—è–¥: 0 (–†–µ–∫–æ—Ä–¥: 0)</span>
                    </div>
                </div>
            </div>

            <!-- –§—É—Ç–µ—Ä —Å –≤–µ—Ä—Å–∏–µ–π -->
            <div class="game-footer" id="versionText">Math Game v1.0.2 | Biscuit</div>

            <!-- Canvas –¥–ª—è –∫–æ–Ω—Ñ–µ—Ç—Ç–∏ -->
            <canvas id="confettiCanvas"></canvas>
        </div>
    </div>

    <script>
        class MathGame {
            constructor() {
                // –°–æ—Å—Ç–æ—è–Ω–∏–µ –∏–≥—Ä—ã (–∫–∞–∫ –≤ Flet)
                this.difficulty = 10;
                this.record = 0;
                this.strike = 0;
                this.currentProblem = { a: 0, b: 0, operand: '+' };
                this.isChecking = false;
                this.gameState = 'input'; // 'input' –∏–ª–∏ 'result'
                
                // DOM —ç–ª–µ–º–µ–Ω—Ç—ã
                this.elements = {
                    loadingScreen: document.getElementById('loadingScreen'),
                    inputMode: document.getElementById('inputMode'),
                    resultMode: document.getElementById('resultMode'),
                    problemText: document.getElementById('problemText'),
                    answerInput: document.getElementById('answerInput'),
                    checkButton: document.getElementById('checkButton'),
                    resultIcon: document.getElementById('resultIcon'),
                    resultText: document.getElementById('resultText'),
                    strikeCounter: document.getElementById('strikeCounter'),
                    strikeText: document.getElementById('strikeText'),
                    versionText: document.getElementById('versionText'),
                    confettiGif: document.getElementById('confettiGif'),
                    confettiCanvas: document.getElementById('confettiCanvas')
                };
                
                this.init();
            }
            
            init() {
                this.setupCanvas();
                this.setupEventListeners();
                this.loadSettings();
                this.generateProblem();
                this.updateDisplay();
                this.hideLoading();
                
                // –§–æ–∫—É—Å –Ω–∞ –ø–æ–ª–µ –≤–≤–æ–¥–∞
                setTimeout(() => {
                    this.elements.answerInput.focus();
                }, 100);
            }
            
            setupCanvas() {
                // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ canvas –¥–ª—è –∫–æ–Ω—Ñ–µ—Ç—Ç–∏
                const canvas = this.elements.confettiCanvas;
                canvas.width = canvas.offsetWidth;
                canvas.height = canvas.offsetHeight;
            }
            
            setupEventListeners() {
                // –ö–Ω–æ–ø–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏
                this.elements.checkButton.addEventListener('click', () => this.checkAnswer());
                
                // Enter –≤ –ø–æ–ª–µ –≤–≤–æ–¥–∞
                this.elements.answerInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && !this.isChecking) {
                        this.checkAnswer();
                    }
                });
                
                // –í–∞–ª–∏–¥–∞—Ü–∏—è –≤–≤–æ–¥–∞ (—Ç–æ–ª—å–∫–æ —á–∏—Å–ª–∞ –∏ –º–∏–Ω—É—Å)
                this.elements.answerInput.addEventListener('input', (e) => {
                    let value = e.target.value;
                    if (value && !/^-?\d*$/.test(value)) {
                        e.target.value = value.slice(0, -1);
                    }
                });
                
                // –§–æ–∫—É—Å –Ω–∞ –ø–æ–ª–µ –≤–≤–æ–¥–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫—É
                document.addEventListener('click', (e) => {
                    if (!this.isChecking && e.target !== this.elements.answerInput) {
                        this.elements.answerInput.focus();
                    }
                });
                
                // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–≥–æ –æ–∫–Ω–∞ (Glide)
                window.addEventListener('message', this.handleMessage.bind(this));
                
                // –†–µ—Å–∞–π–∑ canvas
                window.addEventListener('resize', () => {
                    const canvas = this.elements.confettiCanvas;
                    canvas.width = canvas.offsetWidth;
                    canvas.height = canvas.offsetHeight;
                });
            }
            
            handleMessage(event) {
                // –î–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –º–æ–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä—è—Ç—å origin
                // if (event.origin !== 'https://your-glide-app.glideapp.io') return;
                
                const data = event.data;
                
                switch (data.type) {
                    case 'SET_DIFFICULTY':
                        this.setDifficulty(data.value);
                        break;
                        
                    case 'SET_RECORD':
                        this.setRecord(data.value);
                        break;
                        
                    case 'RESET_GAME':
                        this.resetGame();
                        break;
                }
            }
            
            setDifficulty(value) {
                const validDifficulties = [10, 20, 50, 100, 200, 500, 1000];
                if (validDifficulties.includes(parseInt(value))) {
                    this.difficulty = parseInt(value);
                    this.resetGame();
                    this.showSettingsApplied();
                }
            }
            
            setRecord(value) {
                const newRecord = parseInt(value);
                if (!isNaN(newRecord) && newRecord > this.record) {
                    this.record = newRecord;
                    this.updateDisplay();
                }
            }
            
            loadSettings() {
                // –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑ URL
                const urlParams = new URLSearchParams(window.location.search);
                
                // –°–ª–æ–∂–Ω–æ—Å—Ç—å
                const difficultyParam = urlParams.get('difficulty');
                if (difficultyParam) {
                    const num = parseInt(difficultyParam);
                    const validDifficulties = [10, 20, 50, 100, 200, 500, 1000];
                    if (validDifficulties.includes(num)) {
                        this.difficulty = num;
                    }
                }
                
                // –†–µ–∫–æ—Ä–¥
                const recordParam = urlParams.get('record');
                if (recordParam) {
                    const num = parseInt(recordParam);
                    if (!isNaN(num) && num >= 0) {
                        this.record = num;
                    }
                }
                
                // –°–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π —Ä–µ–∫–æ—Ä–¥ –∏–∑ localStorage
                const savedRecord = localStorage.getItem('mathGameRecord');
                if (savedRecord && !recordParam) {
                    this.record = Math.max(this.record, parseInt(savedRecord) || 0);
                }
            }
            
            generateProblem() {
                // –°–ª—É—á–∞–π–Ω–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è: + –∏–ª–∏ -
                this.currentProblem.operand = Math.random() > 0.5 ? '+' : '-';
                
                // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —á–∏—Å–µ–ª –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å–ª–æ–∂–Ω–æ—Å—Ç–∏
                if (this.currentProblem.operand === '+') {
                    // –°–ª–æ–∂–µ–Ω–∏–µ: a + b ‚â§ difficulty
                    this.currentProblem.a = Math.floor(Math.random() * (this.difficulty + 1));
                    this.currentProblem.b = Math.floor(Math.random() * (this.difficulty - this.currentProblem.a + 1));
                } else {
                    // –í—ã—á–∏—Ç–∞–Ω–∏–µ: b ‚â§ a
                    this.currentProblem.a = Math.floor(Math.random() * (this.difficulty + 1));
                    this.currentProblem.b = Math.floor(Math.random() * (this.currentProblem.a + 1));
                }
                
                // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
                this.elements.problemText.textContent = 
                    `${this.currentProblem.a} ${this.currentProblem.operand} ${this.currentProblem.b} =`;
            }
            
            checkAnswer() {
                if (this.isChecking) return;
                
                const answer = this.elements.answerInput.value.trim();
                
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–≤–æ–¥–∞
                if (!answer) {
                    this.showMessage('–ù—É–∂–Ω–æ –≤–≤–µ—Å—Ç–∏ —Ä–µ—à–µ–Ω–∏–µ');
                    return;
                }
                
                const userAnswer = parseInt(answer);
                if (isNaN(userAnswer)) {
                    this.showMessage('–í–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ');
                    return;
                }
                
                this.isChecking = true;
                
                // –í—ã—á–∏—Å–ª–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞
                const correctAnswer = this.currentProblem.operand === '+' 
                    ? this.currentProblem.a + this.currentProblem.b 
                    : this.currentProblem.a - this.currentProblem.b;
                
                const isCorrect = userAnswer === correctAnswer;
                
                // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–≤–µ—Ç–∞
                if (isCorrect) {
                    this.handleCorrectAnswer();
                } else {
                    this.handleIncorrectAnswer();
                }
                
                // –ü–æ–∫–∞–∑–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç
                this.showResult(isCorrect);
            }
            
            handleCorrectAnswer() {
                this.strike++;
                
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –Ω–æ–≤—ã–π —Ä–µ–∫–æ—Ä–¥
                if (this.strike > this.record) {
                    this.record = this.strike;
                    this.saveRecord();
                    this.sendRecordUpdate();
                }
                
                // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ UI –¥–ª—è —É—Å–ø–µ—Ö–∞
                this.elements.resultText.textContent = this.strike % 5 === 0 
                    ? '–í–µ–ª–∏–∫–æ–ª–µ–ø–Ω–æ!' 
                    : '–í–µ—Ä–Ω–æ!';
                this.elements.resultText.className = 'result-text success';
                this.elements.resultIcon.className = 'result-icon success';
                this.elements.resultIcon.innerHTML = '<span class="material-symbols-outlined">check_circle</span>';
                
                // –ü–æ–∫–∞–∑–∞—Ç—å GIF –∫–æ–Ω—Ñ–µ—Ç—Ç–∏ –¥–ª—è –∫–∞–∂–¥—ã—Ö 5 –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤
                if (this.strike % 5 === 0 && this.strike > 0) {
                    this.elements.confettiGif.classList.add('active');
                    this.elements.resultIcon.style.display = 'none';
                    this.showConfetti();
                } else {
                    this.elements.confettiGif.classList.remove('active');
                    this.elements.resultIcon.style.display = 'flex';
                }
                
                // –û–±–Ω–æ–≤–∏—Ç—å —Å—á–µ—Ç—á–∏–∫ —Å–µ—Ä–∏–∏
                this.updateStrikeCounter();
            }
            
            handleIncorrectAnswer() {
                this.strike = 0;
                
                // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ UI –¥–ª—è –æ—à–∏–±–∫–∏
                this.elements.resultText.textContent = '–ù–µ–≤–µ—Ä–Ω–æ!';
                this.elements.resultText.className = 'result-text error';
                this.elements.resultIcon.className = 'result-icon error';
                this.elements.resultIcon.innerHTML = '<span class="material-symbols-outlined">cancel</span>';
                this.elements.confettiGif.classList.remove('active');
                this.elements.resultIcon.style.display = 'flex';
                
                // –°–∫—Ä—ã—Ç—å —Å—á–µ—Ç—á–∏–∫ —Å–µ—Ä–∏–∏
                this.elements.strikeCounter.classList.add('hidden');
            }
            
            showResult(isCorrect) {
                // –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ä–µ–∂–∏–º—ã
                this.elements.inputMode.classList.add('hidden');
                this.elements.resultMode.classList.add('active');
                
                // –ê–Ω–∏–º–∞—Ü–∏—è –∏–∫–æ–Ω–∫–∏
                const icon = this.elements.resultIcon;
                icon.style.animation = 'none';
                void icon.offsetWidth; // Trigger reflow
                
                if (isCorrect) {
                    icon.classList.remove('animate-slow');
                    icon.classList.add('animate-fast');
                }
                
                // –ó–∞–¥–µ—Ä–∂–∫–∞ –∏ –≤–æ–∑–≤—Ä–∞—Ç –∫ –≤–≤–æ–¥—É (–∫–∞–∫ –≤ Flet)
                const delay = isCorrect ? 2000 : 2000;
                
                setTimeout(() => {
                    this.returnToInput();
                }, delay);
            }
            
            returnToInput() {
                // –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ä–µ–∂–∏–º—ã
                this.elements.resultMode.classList.remove('active');
                this.elements.inputMode.classList.remove('hidden');
                
                // –°–±—Ä–æ—Å–∏—Ç—å –∞–Ω–∏–º–∞—Ü–∏—é
                this.elements.resultIcon.classList.remove('animate-fast', 'animate-slow');
                this.elements.resultIcon.style.animation = '';
                
                // –ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞
                this.generateProblem();
                
                // –û—á–∏—Å—Ç–∏—Ç—å –ø–æ–ª–µ –≤–≤–æ–¥–∞ –∏ —Ñ–æ–∫—É—Å
                this.elements.answerInput.value = '';
                this.elements.answerInput.focus();
                
                // –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É
                this.isChecking = false;
            }
            
            showSettingsApplied() {
                // –ü–æ–∫–∞–∑–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏
                this.elements.inputMode.classList.add('hidden');
                this.elements.resultMode.classList.add('active');
                
                // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ UI
                this.elements.resultText.textContent = '–ü—Ä–∏–º–µ–Ω—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏...';
                this.elements.resultText.className = 'result-text settings';
                this.elements.resultIcon.className = 'result-icon settings';
                this.elements.resultIcon.innerHTML = '<span class="material-symbols-outlined">settings</span>';
                this.elements.confettiGif.classList.remove('active');
                this.elements.resultIcon.style.display = 'flex';
                this.elements.strikeCounter.classList.add('hidden');
                
                // –ê–Ω–∏–º–∞—Ü–∏—è –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–µ–∫
                const icon = this.elements.resultIcon;
                icon.style.animation = 'none';
                void icon.offsetWidth;
                icon.classList.remove('animate-fast');
                icon.classList.add('animate-slow');
                
                // –ó–∞–¥–µ—Ä–∂–∫–∞ –∫–∞–∫ –≤ Flet (4 —Å–µ–∫—É–Ω–¥—ã)
                setTimeout(() => {
                    this.returnToInput();
                    this.updateDisplay();
                }, 4000);
            }
            
            showConfetti() {
                // –ü–æ–∫–∞–∑–∞—Ç—å canvas –∫–æ–Ω—Ñ–µ—Ç—Ç–∏
                this.elements.confettiCanvas.style.display = 'block';
                
                // –ó–∞–ø—É—Å—Ç–∏—Ç—å –∫–æ–Ω—Ñ–µ—Ç—Ç–∏
                confetti({
                    particleCount: 150,
                    spread: 70,
                    origin: { y: 0.6 },
                    colors: ['#FFD700', '#4CAF50', '#2196F3', '#FF9800', '#E91E63']
                });
                
                // –°–∫—Ä—ã—Ç—å —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
                setTimeout(() => {
                    this.elements.confettiCanvas.style.display = 'none';
                }, 3000);
            }
            
            resetGame() {
                this.strike = 0;
                this.generateProblem();
                this.elements.answerInput.value = '';
                this.elements.strikeCounter.classList.add('hidden');
            }
            
            updateDisplay() {
                // –û–±–Ω–æ–≤–∏—Ç—å –≤–µ—Ä—Å–∏—é –≤ —Ñ—É—Ç–µ—Ä–µ
                this.elements.versionText.textContent = `Math Game v1.0.2 | –î–æ ${this.difficulty}`;
            }
            
            updateStrikeCounter() {
                if (this.strike >= 3) {
                    const isRecord = this.strike === this.record;
                    this.elements.strikeText.textContent = 
                        isRecord 
                            ? `–†–µ–∫–æ—Ä–¥ –¥–æ—Å—Ç–∏–≥–Ω—É—Ç: ${this.record}`
                            : `–ü–æ–¥—Ä—è–¥: ${this.strike} (–†–µ–∫–æ—Ä–¥: ${this.record})`;
                    this.elements.strikeCounter.classList.remove('hidden');
                } else {
                    this.elements.strikeCounter.classList.add('hidden');
                }
            }
            
            saveRecord() {
                localStorage.setItem('mathGameRecord', this.record);
            }
            
            sendRecordUpdate() {
                const message = {
                    type: 'RECORD_UPDATE',
                    record: this.record,
                    difficulty: this.difficulty,
                    strike: this.strike,
                    timestamp: Date.now()
                };
                
                // –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–º—É –æ–∫–Ω—É (Glide)
                if (window.parent !== window) {
                    window.parent.postMessage(message, '*');
                }
                
                // –¢–∞–∫–∂–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å opener –µ—Å–ª–∏ –µ—Å—Ç—å
                if (window.opener) {
                    window.opener.postMessage(message, '*');
                }
            }
            
            showMessage(text) {
                // –í—Ä–µ–º–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (–º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å Snackbar –∫–∞–∫ –≤ Flet)
                alert(text);
            }
            
            hideLoading() {
                setTimeout(() => {
                    this.elements.loadingScreen.style.display = 'none';
                }, 500);
            }
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏–≥—Ä—ã
        document.addEventListener('DOMContentLoaded', () => {
            window.mathGame = new MathGame();
            
            // API –¥–ª—è –≤–Ω–µ—à–Ω–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
            window.MathGameAPI = {
                setDifficulty: (value) => {
                    if (window.mathGame) {
                        window.mathGame.setDifficulty(value);
                    }
                },
                setRecord: (value) => {
                    if (window.mathGame) {
                        window.mathGame.setRecord(value);
                    }
                },
                resetGame: () => {
                    if (window.mathGame) {
                        window.mathGame.resetGame();
                    }
                },
                getStats: () => {
                    if (window.mathGame) {
                        return {
                            difficulty: window.mathGame.difficulty,
                            record: window.mathGame.record,
                            strike: window.mathGame.strike
                        };
                    }
                    return null;
                }
            };
        });
    </script>
</body>
</html>
